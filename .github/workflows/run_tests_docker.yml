###
# Use the docker container to run tests in a parameterized way.
###

name: Run Docker-based regression tests

on: 
    pull_request:

concurrency:  
  group: ${{ github.workflow}}-${{ github.head_ref }}  
  cancel-in-progress: true

jobs:
    container-test-job:
        runs-on: ubuntu-latest
        
        strategy:
            matrix:
                hdf5: [ 1.12.2, 1.14.6 ]
                netcdf: [ v4.9.3 ]
                ctype: [ serial, mpich ]

        steps:
            - name: Check out Repo
              uses: actions/checkout@v4
            
            - name: Run container ${{ matrix.ctype }}
              uses: addnab/docker-run-action@v3
              with:
                image: docker.unidata.ucar.edu/nctests:${{ matrix.ctype }}
                options: -e TESTPROC=$(nproc) -v $(pwd):/netcdf-fortran -e CBRANCH=${{ matrix.netcdf }} -e H5VER=${{ matrix.hdf5 }} -e RUNC=OFF docker.unidata.ucar.edu/nctests:${{ matrix.ctype }}
                shell: bash
                run: /home/tester/run_serial_tests.sh